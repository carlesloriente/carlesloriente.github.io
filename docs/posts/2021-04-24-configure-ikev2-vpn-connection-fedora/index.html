<!DOCTYPE html>
<html class="h-100" lang="en" data-bs-theme="light">
  <head>
      <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>VPN connection using p12 cert on Fedora 31+</title>
  <meta name="description" content="Using the following script you can install all the libraries needed for IKEv2 IPSec VPNs and configure a roadwarrior connection.">
  <meta name="google-site-verification" content="imA3xlKv43a50bTrOlAa3eWQ3VBCazAY4Y20KImDXOM">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="godarthvader">
  <meta name="twitter:creator" content="godarthvader">
  <meta property="og:url" content="https://www.notesoncloudcomputing.com/posts/2021-04-24-configure-ikev2-vpn-connection-fedora/">
  <meta property="og:title" content="VPN connection using p12 cert on Fedora 31+">
  <meta property="og:description" content="Using the following script you can install all the libraries needed for IKEv2 IPSec VPNs and configure a roadwarrior connection.">
  <meta property="og:image" content="https://www.notesoncloudcomputing.com/assets/images/bg-fedora.webp">
  <meta property="og:type" content="article">
  <link rel="stylesheet" href="/assets/vendor/nocc-bootstrap-theme/css/nocc-theme.css" type="text/css">
<link rel="stylesheet" href="/assets/css/styles.css" type="text/css">
  <link rel="canonical" href="https://www.notesoncloudcomputing.com/posts/2021-04-24-configure-ikev2-vpn-connection-fedora/">
  <link rel="alternate" type="application/rss+xml" title="Notes on Cloud Computing" href="/feed.xml">
  <link rel="shortcut icon" href="/assets/images/favicon.ico">
  <link rel="icon" href="/assets/images/favicon.ico" sizes="any">
  <link rel="icon" href="/assets/images/favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/assets/images/favicon.png" type="image/png">
  <link rel="manifest" href="/manifest.webmanifest"><!-- Global site tag (gtag.js) - Google Analytics -->
<script type="text/javascript" async src="https://www.googletagmanager.com/gtag/js?id=G-YZN6D91Z4N" ></script>
<script type="text/javascript">
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-YZN6D91Z4N', {cookie_flags: 'SameSite=None;Secure'});
</script>
</head>
  <body class="d-flex flex-column h-100" style="overflow-x: hidden;">
    <header>
        <div class="position-fixed bottom-0 end-0 mb-3 me-3">
      <button class="btn-toggle py-2 d-flex align-items-center" id="bd-toggle" data-bs-toggle="button" type="button" aria-expanded="false" aria-label="Toggle theme color">
        <span class="daylight filter-white"></span>
      </button>
    </div>
    <script type="text/javascript" src="/assets/vendor/nocc-bootstrap-theme/js/theme-toggler.js"></script>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg fixed-top" id="mainNav">
      <div class="container">
        <a class="navbar-brand" hreflang="en" href="/">Notes on Cloud Computing</a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          Menu
          <i class="fa fa-bars"></i>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarResponsive">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" hreflang="en" href="/" aria-label="Notes on Cloud Computing Home">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" hreflang="en" href="/about" aria-label="Notes on Cloud Computing About">About</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" hreflang="en" href="/posts" aria-label="Notes on Cloud Computing Posts">Posts</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" hreflang="en" href="/tags" aria-label="Notes on Cloud Computing Tags">Tags</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" hreflang="en" href="/gallery" aria-label="Notes on Cloud Computing Gallery of images">Gallery</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" hreflang="en" href="/contact" aria-label="Notes on Cloud Computing Contact form">Contact</a>
            </li>
            <li class="nav-item">
              <a href="https://github.com/carlesloriente/carlesloriente.github.io" target="_blank" hreflang="en" rel="noreferrer" class="nx-p-2 nx-text-current"><img class="nav-github" alt="NotesOnCloudComputing Github repo stars" src="https://img.shields.io/github/stars/carlesloriente/carlesloriente.github.io?style=social"></a>
            </li>
            <li class="nav-item">
              <a href="https://ko-fi.com/S6S1O2GTU" target="_blank" hreflang="en" rel="noopener" title="Support me on ko-fi.com"><img class="nav-kofi" src="/assets/vendor/nocc-bootstrap-theme/images/nocc/kofi_s_logo_nolabel.webp" border="0" alt="Buy Me a Coffee at ko-fi.com" /></a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    </header>
  <main class="flex-shrink-0">
  
  <section class="masthead sechead" style="background-image: linear-gradient(to bottom, rgba(0,0,0,0.5)0%,rgba(0,0,0,0.5) 100%), url('/assets/images/bg-fedora.webp')">
  
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 mx-auto">
          <div class="post-heading">
            <h1 class="mx-auto">VPN connection using p12 cert on Fedora 31+</h1></div>
        </div>
      </div>
    </div>
  </section>
  <section>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <div class="meta text-center">Posted by
            <a href="/about" hreflang="en" aria-label="Author">Carles Loriente </a>  on April 24, 2021 &middot; <span class="reading-time" title="Estimated read time"> 4 mins  read</span>
</div>
          <hr class="border border-primary opacity-25">
          <p>Using the following script you can install all the libraries needed for IKEv2 IPSec VPNs and configure a roadwarrior connection.</p>

<p>Requirements:</p>

<ul>
  <li>IKEv2 IPsec VPN gateway</li>
  <li>P12 User Certificate with passphrase</li>
  <li>Your Fedora OS should be in english language</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">sudo </span>dnf remove <span class="nt">-y</span> strongswan NetworkManager-strongswan NetworkManager-strongswan-gnome strongswan-libipsec
<span class="nb">sudo </span>dnf <span class="nb">install</span> <span class="nt">-y</span> libreswan NetworkManager-libreswan NetworkManager-libreswan-gnome ldns nss-tools firewall-config

<span class="nb">echo</span> <span class="s2">"Changing ipsec.conf"</span>
<span class="nb">sudo sed</span> <span class="nt">-i</span> <span class="s1">'s/# dnssec-enable=no/dnssec-enable=no/g'</span> /etc/ipsec.conf
<span class="nb">sudo sed</span> <span class="nt">-i</span> <span class="s1">'s/#DNSSEC=allow-downgrade/DNSSEC=false/g'</span> /etc/systemd/resolved.conf

<span class="nb">echo</span> <span class="s2">"Configuring Firewall"</span>
<span class="nb">sudo </span>firewall-cmd <span class="nt">--permanent</span> <span class="nt">--zone</span><span class="o">=</span>FedoraWorkstation <span class="nt">--add-service</span> ipsec 
<span class="nb">sudo </span>firewall-cmd <span class="nt">--permanent</span> <span class="nt">--add-port</span><span class="o">=</span>500/udp
<span class="nb">sudo </span>firewall-cmd <span class="nt">--permanent</span> <span class="nt">--add-port</span><span class="o">=</span>4500/udp
<span class="nb">sudo </span>firewall-cmd <span class="nt">--reload</span>

<span class="nb">sudo mkdir</span> <span class="nt">-p</span> /var/lib/ipsec/nss
<span class="c">#sudo chmod 755 /var/lib/ipsec/nss/ /etc/ipsec.d/</span>
<span class="c">#sudo chown ${name}:${name} /var/lib/ipsec/nss/</span>
<span class="c">#sudo chmod 644 /var/lib/ipsec/nss/*.*</span>
<span class="nb">sudo </span>ipsec initnss

<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">read</span> <span class="nt">-p</span> <span class="s2">"Enter your username: "</span> name
<span class="nv">name</span><span class="o">=</span><span class="k">${</span><span class="nv">name</span><span class="k">}</span>

<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">read</span> <span class="nt">-p</span> <span class="s2">"Enter the VPN gateway: "</span> vpn
<span class="nv">vpn</span><span class="o">=</span><span class="k">${</span><span class="nv">vpn</span><span class="k">}</span>
<span class="nb">echo</span> <span class="s2">"Your ID is </span><span class="k">${</span><span class="nv">name</span><span class="k">}</span><span class="s2">@</span><span class="k">${</span><span class="nv">vpn</span><span class="k">}</span><span class="s2">"</span>

<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"Rename your cert file to </span><span class="k">${</span><span class="nv">name</span><span class="k">}</span><span class="s2">@</span><span class="k">${</span><span class="nv">vpn</span><span class="k">}</span><span class="s2">.p12"</span>
<span class="nb">echo</span> <span class="s2">"and save it to your ~/Documents folder"</span>

<span class="nb">read</span> <span class="nt">-p</span> <span class="s2">"Press [Enter] to continue..."</span>

<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="k">${</span><span class="nv">HOME</span><span class="k">}</span>/Documents/<span class="k">${</span><span class="nv">name</span><span class="k">}</span>@<span class="k">${</span><span class="nv">vpn</span><span class="k">}</span>.p12 <span class="o">]</span>
<span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"~/Documents/</span><span class="k">${</span><span class="nv">name</span><span class="k">}</span><span class="s2">@</span><span class="k">${</span><span class="nv">vpn</span><span class="k">}</span><span class="s2">.p12 does not exist, error"</span>
    <span class="nb">exit </span>0
<span class="k">else
    </span><span class="nb">echo</span> <span class="s2">""</span>
    <span class="nb">echo</span> <span class="s2">"Now you need the VPN password to import the certificate"</span>
    <span class="nb">sudo </span>ipsec import ~/Documents/<span class="k">${</span><span class="nv">name</span><span class="k">}</span>@<span class="k">${</span><span class="nv">vpn</span><span class="k">}</span>.p12
<span class="k">fi

</span><span class="nb">echo</span> <span class="s2">"Create configuration file for IPSec connection, connection name awsibikev2"</span>

<span class="nb">sudo dd </span><span class="nv">of</span><span class="o">=</span>/etc/ipsec.d/roadwarriorclient.conf <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
conn roadwarriorvpn
    ikev2=insist
    left=%defaultroute
    leftsubnet=0.0.0.0/0
    leftcert=</span><span class="k">${</span><span class="nv">name</span><span class="k">}</span><span class="sh">@</span><span class="k">${</span><span class="nv">vpn</span><span class="k">}</span><span class="sh">
    leftid=%fromcert
    leftmodecfgclient=yes
    right=</span><span class="k">${</span><span class="nv">vpn</span><span class="k">}</span><span class="sh">
    rightid=%fromcert
    rightsubnet=0.0.0.0/0
    rightca=%same
    authby=rsasig
    narrowing=yes
    mobike=yes
    auto=add
</span><span class="no">EOF

</span><span class="nb">echo</span> <span class="s2">"Added to .bashrc start_vpn and stop_vpn commands"</span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh"> &gt;&gt; </span><span class="nv">$HOME</span><span class="sh">/.bashrc
function start_vpn()
{
    sudo ipsec auto --up roadwarriorvpn
}
function stop_vpn()
{
    sudo ipsec auto --down roadwarriorvpn
}
</span><span class="no">EOT

</span><span class="nb">sudo </span>semanage fcontext <span class="nt">-a</span> <span class="nt">-t</span> ipsec_key_file_t <span class="s1">'/var/lib/ipsec/nss'</span>
<span class="nb">sudo </span>restorecon <span class="nt">-v</span> /var/lib/ipsec/<span class="k">*</span>

<span class="nb">sudo </span>systemctl <span class="nb">enable </span>ipsec
<span class="nb">sudo </span>ipsec pluto <span class="nt">--stderrlog</span> <span class="nt">--config</span> /etc/ipsec.conf

<span class="nb">echo</span> <span class="s2">"Please reboot the system"</span>
</code></pre></div></div>

<p>Download GitHub Gist <a href="https://gist.github.com/carlesloriente/4496fa54e444456435ec7e7e897a28e3" target="_blank">fedora-configure-and-setup-ikev2.sh</a></p>

<p>Save the script to your $HOME folder and execute it in shell using the command: <code>sudo sh configure-and-setup-ikev2.sh</code></p>

<p>When the script has finished the message “Please reboot the system” will appear on your terminal, please reboot it. After that your IKEv2 connection will be configured, you can start the connection using shell typing in “start_vpn” (without quotes), or stop it typing in “stop_vpn” (without quotes).</p>

<h2 id="related-articles">Related articles</h2>

<p><a href="/posts/2021-04-23-configure-vpn-server-ikev2-ipsec-with-certificates-mikrotik-routeros/">Configure a VPN server using IKEv2 IPSec with certificates on Mikrotik RouterOS</a></p>

          <hr>
          <div class="text-center">
            <p><mark>Found a snippet that saved your day?</mark> Consider <a href="https://ko-fi.com/S6S1O2GTU" target="_blank" rel="noopener" title="Support me on ko-fi.com">dropping a tip!</a></p>
            <script type="text/javascript" src="/assets/vendor/nocc-bootstrap-theme/js/ko-fi/widget_2.min.js"></script>
            <script type="text/javascript">kofiwidget2.init("Buy me a coffee", "#176391", "S6S1O2GTU");kofiwidget2.draw();</script>
          </div>
          <hr>
          <div class="clearfix">
            
              
                
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
      this.page.url = 'https://www.notesoncloudcomputing.com/posts/2021-04-24-configure-ikev2-vpn-connection-fedora/';
      this.page.identifier = 'https://www.notesoncloudcomputing.com/posts/2021-04-24-configure-ikev2-vpn-connection-fedora/';
    };
    (function() {
      var d = document, s = d.createElement('script');
      s.src = 'https://notes-on-cloud-infrastructure.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

              
            
            
            <a class="btn btn-primary float-start" href="/posts/2021-04-23-configure-vpn-server-ikev2-ipsec-with-certificates-mikrotik-routeros/" hreflang="en" data-bs-toggle="tooltip" data-bs-placement="top" title="VPN server using IKEv2 IPSec with certificates on RouterOS">&larr; Previous<span class="d-none d-md-inline">
                Post</span></a>
            
            
            <a class="btn btn-primary float-end" href="/posts/2023-08-05-fix-brew-stuck-updating/" hreflang="en" data-bs-toggle="tooltip" data-bs-placement="top" title="Fix Brew stuck/hangs updating in MacOs">Next<span class="d-none d-md-inline">
                Post</span> &rarr;</a>
            
          </div>
        </div>
      </div>
    </div>
    <div class="divider"></div>
  </section>
  </main>
  
    
<!-- Footer -->
<footer class="footer mt-auto">
  <div class="container">
    <ul class="list-inline text-center">
      <li class="list-inline-item rounded-circle">
        <a href="mailto:fi1nziulf@mozmail.com" hreflang="en" aria-label="fi1nziulf@mozmail.com address">
          <img class="filter-white" src="/assets/vendor/nocc-bootstrap-theme/icons/1.11.0/envelope-at-fill.svg" width="32px" height="32px" aria-hidden="true">
        </a>
      </li><li class="list-inline-item rounded-circle">
        <a href="https://twitter.com/godarthvader" hreflang="en" target="_blank" rel="noreferrer" aria-label="godarthvader Twitter">
          <img class="filter-white" src="/assets/vendor/nocc-bootstrap-theme/icons/1.11.0/twitter-x.svg" width="32px" height="32px" aria-hidden="true">
        </a>
      </li><li class="list-inline-item rounded-circle">
        <a href="https://www.linkedin.com/in/carles-loriente" hreflang="en" target="_blank" rel="noreferrer" aria-label="carles-loriente Linkedin">
          <img class="filter-white" src="/%20/assets/vendor/nocc-bootstrap-theme/icons/1.11.0/linkedin.svg" width="32px" height="32px" aria-hidden="true">
        </a>
      </li><li class="list-inline-item rounded-circle">
        <a href="https://github.com/carlesloriente" hreflang="en" target="_blank" rel="noreferrer" aria-label="carlesloriente GitHub">
          <img class="filter-white" src="/assets/vendor/nocc-bootstrap-theme/icons/1.11.0/github.svg" width="32px" height="32px" aria-hidden="true">
        </a>
      </li></ul>
    <p class="copyright text-copyright">Copyright &copy; <a href="/about" hreflang="en" aria-label="Notes on Cloud Computing author">Carles Loriente</a> 2024<br />
      <a href="https://bootstrap-theme.notesoncloudcomputing.com/" hreflang="en" target="_blank" rel="noreferrer" aria-label="NOCC Bootstrap Theme">NOCC Bootstrap Theme</a> v.1.0.6 created by <a href="https://www.notesoncloudcomputing.com/about/" hreflang="en" target="_blank" rel="noreferrer" aria-label="Autor website https://www.notesoncloudcomputing.com/about/">Carles Loriente</a><br />
      Build with <a href="https://jekyllrb.com" hreflang="en" target="_blank" rel="noreferrer" aria-label="Jekyll">Jekyll</a><br />
      Proudly hosted by <a href="https://github.com" hreflang="en" target="_blank" rel="noreferrer" aria-label="Github"><strong>GitHub</strong></a>
    </p>
  </div>
</footer>
    
<script type="text/javascript" rel="preload" src="/assets/vendor/nocc-bootstrap-theme/js/jquery/3.7.1/jquery.min.js"></script>
<script type="text/javascript" src="/assets/vendor/nocc-bootstrap-theme/js/bootstrap/5.3.3/bootstrap.bundle.min.js"></script>
<script type="text/javascript" src="https://notes-on-cloud-infrastructure.disqus.com/count.js" async id="dsq-count-scr"></script>
  </body>
</html>